name: Microservice CI with LocalStack and Docker Cache

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        service: [localstack, ryuk]

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK with Maven cache
        uses: actions/setup-java@v3
        with:
          distribution: 'corretto'
          java-version: '17'
          cache: maven  # Automatically caches Maven dependencies

      # Get Docker image for either LocalStack or Ryuk in parallel
      - name: Get Docker image
        run: |
          if [ "${{ matrix.service }}" == "localstack" ]; then
            echo "Handling LocalStack Docker image..."
            if [ -f ~/.docker-cache/localstack.tar ]; then
              echo "Loading LocalStack Docker image from cache..."
              docker load -i ~/.docker-cache/localstack.tar
            else
              echo "LocalStack image not found in cache, pulling from Docker Hub..."
              for i in {1..3}; do
                if docker pull localstack/localstack:3.7.0; then
                  echo "LocalStack pulled successfully."
                  break
                else
                  echo "Failed to pull LocalStack image, retrying in 10 seconds..."
                  sleep 10
                fi
              done
              echo "Saving LocalStack image to cache..."
              mkdir -p ~/.docker-cache
              docker save localstack/localstack:3.7.0 -o ~/.docker-cache/localstack.tar
            fi
          elif [ "${{ matrix.service }}" == "ryuk" ]; then
            echo "Handling Ryuk Docker image..."
            if [ -f ~/.docker-cache/ryuk.tar ]; then
              echo "Loading Ryuk Docker image from cache..."
              docker load -i ~/.docker-cache/ryuk.tar
            else
              echo "Ryuk image not found in cache, pulling from Docker Hub..."
              for i in {1..3}; do
                if docker pull testcontainers/ryuk:0.7.0; then
                  echo "Ryuk pulled successfully."
                  break
                else
                  echo "Failed to pull Ryuk image, retrying in 10 seconds..."
                  sleep 10
                fi
              done
              echo "Saving Ryuk image to cache..."
              mkdir -p ~/.docker-cache
              docker save testcontainers/ryuk:0.7.0 -o ~/.docker-cache/ryuk.tar
            fi
          fi

      # Start LocalStack container only if LocalStack was handled
      - name: Start LocalStack container
        if: matrix.service == 'localstack'
        run: |
          echo "Starting LocalStack container..."
          docker run -d --name localstack \
            -p 127.0.0.1:4566:4566 \
            -e SERVICES=dynamodb \
            localstack/localstack:3.7.0

      # Build and run tests (executed after both services are ready)
      - name: Build and run tests
        run: mvn verify
